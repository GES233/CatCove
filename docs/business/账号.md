# 账号功能

## 讨论范畴

账号的注册、登录、登出以及注销；

账号的资料修改、权限修改与冻结。

## 基本

### 鉴权 —— 「我怎么知道你是你？」

API采用请求头/请求参数鉴权（详见`docs/business/API.md`）；服务器渲染端采用 Cookie 。

考虑到服务器体量以及性能问题，不是每一次的请求都会到数据库去查询以认证的，因此**不允许**明文编码且**必须加密**。

> **NOTICE**：生产环境下请设定应用配置的 `INSTANCE = True` 且不要泄露自动生成的实例文件夹内的 `SECRET_KEY` 以及ECC私钥。

API端与网页渲染端有大同小异的业务逻辑，因此加密方式也会一样，无非一个变为 Token ，而另一个变为 Cookie 。

其 payload 格式如下：

```json
{
    "id": 2,
    "nickname": "Jack's stove",
    "role": "normal",
    "status": "normal"
}
```

其中：

- `id` 为用户名
- `nickname` 为用户的昵称（支持UTF-8）
- `role` 是否为管理员
- `status` 为用户的状态

由此不难看出，每一次对以上内容的更新（包括但不限于修改昵称、账号被禁以及解禁、被任命/移除管理员）都会导致对应 payload 的更新，其中使用 Cookie 的服务器渲染端会自动更新， API 端会返回 `[token]` 字段，需要客户端更新。

#### 获得/更新 Token 的情况

详见`docs/business/API.md`

#### 获得/更新 Cookie 的情况

- 注册（选择「跳过登录」的情况）
- 登录
  - 「记住我」 —— 7天后过期
  - 其他 —— 浏览结束就结束
- 修改个人信息后
  - 修改 nickname
  - 主动冻结
- 被封禁或解封 [^push]
- 被任命为管理员或从管理员中被移除 [^push]
- 发言/重新登录时存在上两者状态的更新（对[^push]的取代）

[^push]: 消息推送系统

### 认证 —— 「现在你是你了，但怎么让不知道你是你的我知道你是你？」

检查 Cookie 的情况：代码添加 `@cookie_required` 装饰器的响应函数；

检查 Token 的情况：代码添加 `@token_required` 装饰器的响应函数。

### 用户权限 —— 「就是因为你是你，所以你才不可以在这里〇〇！」

主要是发言权限，暂略。

## 业务流程

该部分为**已经测试过的**代码的业务流程。

### 登录

共同部分：

`request` --> 检查且验证 `form/json`--> 转化为 `LoginModel` --> 检查约束条件（存在用户） --> 返回错误或向数据库提交表单 --> （如果 `remember_me` 为真设置过期日期）返回 Token/Cookie

API：

...

服务器渲染：

...

### 登出

共同部分：

无效化登录操作

API：

略

服务器渲染：

- 如有 Cookie
  - 清零 Cookie
  - 返回 `auth/logout.html`
- 如无 Cookie
  - 跳转至 (比利比利网)[https://www.bilibili.com]

### 注册

流程：

`request` --> 检查且验证 `form/json`--> 转化为 `SignUpModel` --> 检查约束条件（相同用户等） --> 返回错误或向数据库提交表单 --> （如果 `auto_login` 为真）返回 Token/Cookie 或跳转至登录页面

服务器渲染：

- 检查 `form`
  - `password` 与 `confirm` 一样
  - `nickname` 与 `email` 不冲突 —— 没有重复注册
  - 有邀请码（后期添加）
- 将 `form` 转变为对应的 `SignUpModel`，后端再次检查
- 检查邀请码（后期加入）
- 查询数据库，有无重复用户
- 提交用户
- 跳转至 `/login` 或提供 Cookie 并返回主页

API：

_与服务器渲染大同，除了：_

- 后端检查 `json`
- 不会跳转，如果 `auto_login` 为真会直接返回 Token，否则返回「注册成功」

### 注销

共同部分：

...

API：

...

服务器渲染：

...
