# 账号功能

## 讨论范畴

账号的注册、登录、登出以及注销；

账号的资料修改、权限修改与冻结。

## 基本

### 鉴权 —— 「我怎么知道你是你？」

API采用请求头/请求参数鉴权（详见`docs/business/API.md`）；服务器渲染端采用 Cookie 。

考虑到服务器体量以及性能问题，不是每一次的请求都会到数据库去查询以认证的，因此**不允许**明文编码且**必须加密**。

> **NOTICE**：生产环境下请设定应用配置的 `INSTANCE = True` 且不要泄露自动生成的实例文件夹内的 `SECRET_KEY` 以及ECC私钥。

API端与网页渲染端有大同小异的业务逻辑，因此加密方式也会一样，无非一个变为 Token ，而另一个变为 Cookie 。

其 payload 格式如下：

```json
{
    "id": 2,
    "nickname": "Jack's stove",
    "role": "normal",
    "status": "normal"
}
```

其中：

- `id` 为用户名
- `nickname` 为用户的昵称（支持UTF-8）
- `role` 是否为管理员
- `status` 为用户的状态

由此不难看出，每一次对以上内容的更新（包括但不限于修改昵称、账号被禁以及解禁、被任命/移除管理员）都会导致对应 payload 的更新，其中使用 Cookie 的服务器渲染端会自动更新， API 端会返回 `[token]` 字段，需要客户端更新。

#### 获得/更新 Token 的情况

详见`docs/business/API.md`

#### 获得/更新 Cookie 的情况

- 注册（选择「跳过登录」的情况）
- 登录
  - 「记住我」 —— 7天后过期
  - 其他 —— 浏览结束就结束
- 修改个人信息后
  - 修改 nickname
  - 主动冻结
- 被封禁或解封 [^push]
- 被任命为管理员或从管理员中被移除 [^push]
- 发言/重新登录时存在上两者状态的更新（对[^push]的取代）

[^push]: 消息推送系统

### 认证 —— 「现在你是你了，但怎么让不知道你是你的我知道你是你？」

检查 Cookie 的情况：代码添加 `@cookie_required` 装饰器的响应函数；

检查 Token 的情况：代码添加 `@token_required` 装饰器的响应函数。

### 用户权限 —— 「就是因为你是你，所以你才不可以在这里〇〇！」

主要是发言权限，暂略。

## 业务流程

### 登录

共同部分：

...

API：

...

服务器渲染：

...

### 登出

共同部分：

...

API：

...

服务器渲染：

...

### 注册

共同部分：

...

API：

...

服务器渲染：

...

### 注销

共同部分：

...

API：

...

服务器渲染：

...
